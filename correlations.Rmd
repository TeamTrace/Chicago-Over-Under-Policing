---
title: "Preliminary Analysis of Chicago Police Data"
output:
  html_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 9
    highlight: monochrom
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	fig.align = "center",
	message = FALSE,
	warning = FALSE,
	width.cutoff = 10
)
```


```{r op_up_table pct}

op_up_doj <- crime %>%
  filter(year >= 2013 & year <= 2018) %>%
  mutate(year = as.character(year)) %>%
  # total incidents for the year
  group_by(year, location_police_district) %>%
  summarise(total_incidents = n_distinct(id_case_number),
            total_arrests = n_distinct(id_case_number[status_arrest]),
            
            # shootings
            shootings_total = n_distinct(id_case_number[shot_cat %in% c("Fatal Shooting", "Nonfatal Shooting")]),
            shootings_total_arrest = n_distinct(id_case_number[shot_cat %in% c("Fatal Shooting", "Nonfatal Shooting") & status_arrest]),
            
            # Part I Violents
            violent_total = n_distinct(id_case_number[crime_group_large_inferred == "Part I Violent"]),
            violent_total_arrest = n_distinct(id_case_number[crime_group_large_inferred == "Part I Violent" & status_arrest]),
            
            # drug and quality of life arrests
            drug_poss_buy_arrests = n_distinct(id_case_number[crime_group_inferred == "Narcotics - Possession, Purchase" & status_arrest]),
            mj_para_alc_arrests = n_distinct(id_case_number[drug_crime_class_inferred == "Possession, Purchase" & 
                                                               drug_type_inferred %in% c("Alcohol", "Marijuana", "Para/Synthetic/Fake") & 
                                                               status_arrest]),
            
            drug_sale_arrests = n_distinct(id_case_number[crime_group_inferred == "Narcotics - Manufacture, Sell, Deliver" & status_arrest]),
            
            weapon_violation_arrests = n_distinct(id_case_number[crime_group_inferred == "Weapon Violation" & status_arrest])) %>%
  
  replace(., is.na(.), 0) %>% 
  filter(!location_police_district %in% c("000", "021", "031", "0")) %>%
  as.data.frame()

op_up_doj <- op_up_doj %>%
  as.data.frame() %>%
  mutate(year = ifelse(year %in% c("2013", "2014", "2015"), "2013-2015",
                       "2016-2018")) %>%
  group_by(year, location_police_district) %>%
  summarise_if(is.numeric, sum) %>%
  bind_rows(op_up_doj) %>%

# join with precint demographics
  left_join(
    (districts %>%
       as.data.frame() %>%
       filter(year %in% c("2014", "2017")) %>%
       unique() %>%
       mutate(year = ifelse(
         year == "2014", "2013-2015",
         "2016-2018")) %>%
       bind_rows(districts))
    , by = c("year", "location_police_district")) %>%
  
  mutate(
    shootings_arrest_rate = round((shootings_total_arrest/shootings_total), digits = 2),
    violent_arrest_rate = round((violent_total_arrest/violent_total), digits = 2),
    

    drug_poss_buy_share_allarrest = round((drug_poss_buy_arrests/total_arrests), digits = 2),
    mj_para_alc_share_allarrest = round((mj_para_alc_arrests/total_arrests), digits = 2),
    
    drug_poss_buy_per_100 = round(drug_poss_buy_arrests/(dist_total/100), digits = 2),
    mj_para_alc_per_100 = round(mj_para_alc_arrests/(dist_total/100), digits = 2),
    
    
    drug_poss_sale_arrests = drug_poss_buy_arrests + drug_sale_arrests,
    drug_poss_sale_per_100 = round(drug_poss_sale_arrests/(dist_total/100), digits = 2),
    drug_sale_per_100 = round(drug_sale_arrests/(dist_total/100), digits = 2),
    
    violent_per_100 = violent_total/(dist_total/100),
    shootings_per_100 = shootings_total/(dist_total/100),
    
    weapon_violation_per_100 = round(weapon_violation_arrests/(dist_total/100), digits = 2)) %>%
  
  select(sort(current_vars())) %>%
  select(location_police_district, location_police_district_name, year, everything()) %>%
  unique() 

make_report(as.data.frame(op_up_doj))

op_up_doj %>% write_csv("Output/op_up_doj.csv")

names(op_up_doj)

```

```{r setup pack data}

source("./Functions/default.R")

op_up_doj <- read_csv("Output/op_up_doj.csv", guess_max = 100000)

```

```{r xy}

doj_xy <- op_up_doj %>% 
  filter(year %in% c("2013-2015", "2016-2018")) %>%
  select(location_police_district, 
         year, 
         `% All Arrests Drug Buy, Poss` = drug_poss_buy_share_allarrest, 
       #  drug_poss_buy_per_100,
       # violent_arrest_rate
         `% Shootings w/ Arrest` = shootings_arrest_rate) %>%
  gather("y_measure", "y_value", `% All Arrests Drug Buy, Poss`:`% Shootings w/ Arrest`) 

doj_xy <- op_up_doj %>% 
  filter(year %in% c("2013-2015", "2016-2018")) %>%
  select(location_police_district, 
         year,
       #  dist_percent_blk,
         `District % Black, Latino` = dist_percent_blk_hisp,
         `District % White` = dist_percent_white) %>%
       gather("x_measure", "x_value", `District % Black, Latino`:`District % White`) %>%
  left_join(doj_xy, by = c("location_police_district", "year")) %>%
  rename(Years = year)
  

```

## Scatter plot

```{r doj xy, fig.height=5, fig.width=5}

doj_xy %>% 
  ggplot(aes(x = x_value, y = y_value, color=Years), 
         colour="black", shape=21, size = 1, alpha=.8, label=location_police_district) +
  facet_grid(rows=vars(y_measure), cols=vars(x_measure), 
             labeller = label_wrap_gen(width = 25, multi_line = TRUE), 
             scales = "free") +
  geom_point(size = 2) +
  geom_text(aes(label = ifelse(location_police_district == "011", "11th", "")),
            color="black", hjust=0, vjust=0) +
  geom_smooth(size=.5, linetype = "dashed", method = lm) +
  theme_bw() +
  theme(legend.position="top") +
  ggtitle("District demographics, drug arrests and shooting arrests, before and after DOJ investigation began")

```

```{r lm data}

doj_lm <- op_up_doj %>% 
  filter(year %in% c("2013-2015", "2016-2018")) %>%
  select(location_police_district, 
         year, 
         drug_poss_buy_share_allarrest, 
        # drug_poss_buy_per_100,
         shootings_arrest_rate,
         shootings_per_100,
         shootings_total,
         violent_arrest_rate,
         violent_per_100,
         violent_total,
         #dist_percent_blk,
         dist_percent_blk_hisp,
         dist_percent_white) %>%
  unique()

doj_lm %>% write_csv("before_after_doj.csv")

```

<br>

## Linear models

**In the three years following the DOJ report, the district's share of residents who are black or Latino decreases in significance on the share of all arrests that are for drug purchase and possession, but it's still significant.**

```{r lm1}

summary(lm(drug_poss_buy_share_allarrest ~ dist_percent_blk_hisp,
            data = (doj_lm %>%
                      filter(year == "2013-2015"))))

summary(lm(drug_poss_buy_share_allarrest ~ dist_percent_blk_hisp,
            data = (doj_lm %>%
                      filter(year == "2016-2018"))))

```

<br>

**In the three years following the DOJ report, the district's share of residents who are black or Latino increases in significance on the share of shootings that led to arrest.**

```{r lm2}

summary(lm(shootings_arrest_rate ~ dist_percent_blk_hisp,
            data = (doj_lm %>%
                      filter(year == "2013-2015"))))

summary(lm(shootings_arrest_rate ~ dist_percent_blk_hisp,
            data = (doj_lm %>%
                      filter(year == "2016-2018"))))

```


```{r most frequent}

table <- crime %>%
  filter(year >= 2016 & status_arrest) %>%
  mutate(crime_group = ifelse(str_detect(crime_group_inferred, "Narcotics"), crime_group_inferred, crime_group_large_inferred)) %>%
  group_by(year, location_police_district, crime_group) %>%
  summarise(n=n_distinct(id_case_number)) %>%
  group_by(year, location_police_district) %>%
  mutate(rank = round((rank(-n)),0),
         total = sum(n),
         share_total = round((n/total),2)) %>%
  as.data.frame() %>%
  mutate(year = as.character(year)) %>%

  left_join((
    districts %>%
      select(location_police_district, year, dist_bucket_per_blk_hisp) %>%
      mutate(year = as.character(year)) %>%
      as.data.frame()
  ), by = c("location_police_district", "year")
  ) %>%
  group_by()

table %>%
  filter(rank == 1) %>%
  group_by(year, crime_group, dist_bucket_per_blk_hisp) %>%
  summarise(n = n_distinct(location_police_district)) %>%
  spread( dist_bucket_per_blk_hisp, n)
  
crime %>% count(crime_group_inferred)  

```

```{r most frequent}

crime %>%
  filter(year >= 2016 & status_arrest) %>%
  group_by(year, location_police_district, crime_primary_type) %>%
  summarise(n=n_distinct(id_case_number)) %>%
  group_by(year, location_police_district) %>%
  mutate(rank = round((rank(-n)),0),
         total = sum(n),
         share_total = round((n/total),2)) %>%
  as.data.frame() %>%
  mutate(year = as.character(year)) %>%

  left_join((
    districts %>%
      select(location_police_district, year, dist_bucket_per_blk_hisp) %>%
      mutate(year = as.character(year)) %>%
      as.data.frame()
  ), by = c("location_police_district", "year")
  ) %>%
  filter(rank == 1) %>%
  group_by(year, crime_primary_type, dist_bucket_per_blk_hisp) %>%
  summarise(n = n_distinct(location_police_district)) %>%
  spread( dist_bucket_per_blk_hisp, n)

```

```{r proactive}

crime %>%
  group_by(crime_primary_type, status_arrest) %>%
  summarise(n = n_distinct(id_case_number)) %>%
  spread(status_arrest, n) %>%
  mutate(share_arrest = `TRUE`/(`TRUE`+`FALSE`),
         proactive = ifelse(share_arrest >= .9, TRUE, FALSE)) %>%
  filter(proactive) %>%
  arrange(-`TRUE`) %>%
  dt_simple_long() %>%
  formatPercentage(c("Share Arrest"),0)
  # Narcotics, prostitution, interfering with a police officer, ganbling, liquor law violations


proactive <- crime %>%
  group_by(crime_description, crime_primary_type, status_arrest) %>%
  summarise(n = n_distinct(id_case_number)) %>%
  spread(status_arrest, n) %>%
  replace(., is.na(.), 0) %>% 
  mutate(share_arrest = `TRUE`/(`TRUE`+`FALSE`),
         proactive = ifelse(share_arrest >= .9, TRUE, FALSE))

proactive %>% write_csv("proactive.csv")

proactive %>% dt_simple_long() %>%
  formatPercentage(c("Share Arrest"),0)

proactive %>% group_by(crime_primary_type, proactive) %>%
  summarise()

crime %>%
  group_by(crime_primary_type, status_arrest) %>%
  summarise(n = n_distinct(id_case_number)) %>%
  spread(status_arrest, n) %>%
  replace(., is.na(.), 0) %>% 
  mutate(share_arrest = `TRUE`/(`TRUE`+`FALSE`),
         proactive = ifelse(share_arrest >= .9, TRUE, FALSE))  %>%
  filter(proactive)



```


```{r proactive scatter}

table <- crime %>%
  left_join(proactive, by = "crime_description") %>%
  filter(year >= 2013 & status_arrest) %>%
  group_by(year, location_police_district, proactive) %>%
  summarise(n=n_distinct(id_case_number)) %>%
  group_by(year, location_police_district) %>%
  mutate(rank = round((rank(-n)),0),
         total = sum(n),
         share_total = round((n/total),2)) %>%
  as.data.frame() %>%
  mutate(year = as.character(year)) %>%

  left_join((
    districts %>%
      select(location_police_district, year, dist_percent_blk_hisp) %>%
      mutate(year = as.character(year)) %>%
      as.data.frame()
  ), by = c("location_police_district", "year")
  )   %>%
  filter(proactive)

table %>%  
  ggplot(aes(x = dist_percent_blk_hisp, y = share_total), 
         colour="black", shape=21, size = 1, alpha=.8) +
  facet_grid(cols=vars(year), 
             labeller = label_wrap_gen(width = 25, multi_line = TRUE)) +
  geom_point(size = 2) +
  geom_smooth(size=.5, linetype = "dashed", method = lm) +
  theme_bw() +
  theme(legend.position="top") +
  ggtitle("District Demographics, % All Arrests Proactive",
          "An offense is labled 'proactive' if at least 90% of the reports have an arrest. 
          The top offenses, in order of number of arrests, are: Narcotics, prostitution,
          interfering with a police officer, ganbling, liquor law violations")

crime %>%
  filter(year >= 2013 & year <= 2018 & status_arrest) %>%
    mutate(year = ifelse(
         year == "2014", "2013-2015",
         "2016-2018")) %>%
  left_join(proactive, by = "crime_description") %>%

  group_by(year, location_police_district, proactive) %>%
  summarise(n=n_distinct(id_case_number)) %>%
  group_by(year, location_police_district) %>%
  mutate(rank = round((rank(-n)),0),
         total = sum(n),
         share_total = round((n/total),2)) %>%
  as.data.frame() %>%
  mutate(year = as.character(year)) %>%

left_join(
    (districts %>%
       as.data.frame() %>%
       filter(year %in% c("2014", "2017")) %>%
       unique() %>%
       mutate(year = ifelse(year == "2014", 
                            "2013-2015", "2016-2018"))) 
     , by = c("year", "location_police_district")) %>%

  filter(proactive) %>%  
  ggplot(aes(x = dist_percent_blk_hisp, y = share_total), 
         colour="black", shape=21, size = 1, alpha=.8) +
  facet_grid(cols=vars(year), 
             labeller = label_wrap_gen(width = 25, multi_line = TRUE)) +
  geom_point(size = 2) +
  geom_smooth(size=.5, linetype = "dashed", method = lm) +
  theme_bw() +
  theme(legend.position="top") +
  ggtitle("District Demographics, % All Arrests Proactive",
          "An offense is labled 'proactive' if at least 90% of the reports have an arrest. 
          The top offenses, in order of number of arrests, are: Narcotics, prostitution,
          interfering with a police officer, ganbling, liquor law violations")


# regression is extremely signficant
summary(lm(share_total ~ dist_percent_blk_hisp,
            data = table))

```

```{r property other}

crime %>%
  
  filter(year >= 2016 & year <= 2018 &
           status_arrest) %>%
  left_join((
    districts %>%
      filter(year == "2017") %>%
      mutate(mostly = case_when(dist_percent_white >= .51 ~ "Mostly white",
                                dist_percent_blk_hisp >= .51 ~ "Mostly black/Latino",
                                TRUE ~ "Other")) %>%
      select(location_police_district, mostly, dist_percent_white, dist_percent_blk_hisp) %>%
      
      unique() %>%
      as.data.frame()
  ), by = c("location_police_district")
  ) %>%

  left_join(proactive, by = "crime_description") %>%
  mutate(type = case_when(crime_group_large_inferred %in% 
                            c("Part II Property", "Part I Property", 
                              "Part II Violent", "Part I Violent") ~ "Part I Violent/Property Crime",
                          proactive ~ "Proactive",
                          TRUE ~ "Other")) %>%
  group_by(location_police_district, dist_percent_white, dist_percent_blk_hisp, mostly, type) %>%
  summarise(n=n_distinct(id_case_number)) %>%
  spread(type, n) %>%
  write_csv("mostly.csv")

crime %>%
  filter(year >= 2016 & #year <= 2018 &
           status_arrest) %>%
  left_join((
    districts %>%
      filter(year == "2017") %>%
      mutate(mostly = case_when(dist_percent_white >= .51 ~ "Mostly white",
                                dist_percent_blk_hisp >= .51 ~ "Mostly black/Latino",
                                TRUE ~ "Other")) %>%
      select(location_police_district, mostly) %>%
      
      unique() %>%
      as.data.frame()
  ), by = c("location_police_district")
  ) %>%
  mutate(type = case_when(crime_group_large_inferred %in% 
                            c("Part I Violent", "Part I Property") ~ "Part I",
                          TRUE ~ "Other")) %>%
  group_by(mostly, type) %>%
  summarise(n=n_distinct(id_case_number)) %>%
  group_by(mostly) %>%
  mutate(total = sum(n),
         share_total = round((n/total),2)) %>%
  as.data.frame() %>%

  
  filter(type == "Part I")

```

- Antwan shot in disrtict 22 on 8/21/15
- Melvin Howard shot in district 5 in 6/28/17 

```{r antwan melvin}

hom %>%
  filter( 
    (location_police_district == "005" & year == 2017) |
      (location_police_district == "022" & year == 2015)
    ) %>%
  
  group_by(location_police_district, status) %>%
  summarise(n=n()) %>%
  spread(location_police_district, n) %>%
  adorn_pct_down()

 #              status       005       022     Total
 #     0-OPEN ASSIGNED  84% (38)  50% (11)  73% (49)
 #    3-CLEARED CLOSED   7%  (3)  36%  (8)  16% (11)
 #      4-CLEARED OPEN   2%  (1)   5%  (1)   3%  (2)
 # 5-EX CLEARED CLOSED    - (NA)   5%  (1)   1%  (1)
 #                <NA>   7%  (3)   5%  (1)   6%  (4)
 #               Total 100% (45) 100% (22) 100% (67)

shot %>%
  filter( 
    (location_police_district == "005" & year == 2017) |
      (location_police_district == "022" & year == 2015)) %>%
  filter( shot_cat %in% c("Fatal Shooting", "Nonfatal Shooting")) %>%
  group_by(location_police_district, status) %>%
  summarise(n=n_distinct(id_case_number)) %>%
  spread(location_police_district, n) %>%
  adorn_pct_down()

 # status        005        022       Total
 #     0-OPEN ASSIGNED   4%  (40)  11%  (12)   5%   (52)
 #         1-SUSPENDED  11% (106)  67%  (70)  16%  (176)
 #    3-CLEARED CLOSED   1%  (10)  17%  (18)   3%   (28)
 #      4-CLEARED OPEN   0%   (3)   3%   (3)   1%    (6)
 # 5-EX CLEARED CLOSED   1%   (5)   2%   (2)   1%    (7)
 #   6-EX CLEARED OPEN   0%   (1)    -  (NA)   0%    (1)
 #                <NA>  83% (814)    -  (NA)  75%  (814)
 #               Total 100% (979) 100% (105) 100% (1084)

crime %>%
  filter( 
    (location_police_district == "005" & year == 2017) |
      (location_police_district == "022" & year == 2015)
  ) %>%
  left_join(proactive, by = "crime_description") %>%
  filter(proactive) %>%
  group_by(location_police_district, crime_primary_type) %>%
  summarise(n=n()) %>%
  spread(location_police_district, n) %>%
  adorn_pct_down()
  
```
